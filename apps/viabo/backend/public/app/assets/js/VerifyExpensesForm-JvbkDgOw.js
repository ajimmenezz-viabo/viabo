import{c as V,f as w,a9 as E,s as N,bv as v,P as S,r as P,i as e,bs as I,bt as L,bu as q,bw as p,bx as $,B as _,T as f,V as x,b7 as Q,dA as W,dT as k,dP as T,dU as C,a0 as z}from"./vendor-_TWOdD6q.js";import{u as H}from"./formik.esm-x3Ufw1qH.js";import{c as U,a as F,d as M,g as b}from"./index.esm-wEzUF-or.js";import{q as G,g as K,a as X,S as B}from"./index-nqwTldEB.js";import{f as R}from"./fade-FopuCQlG.js";import{D as Y,C as J}from"./useToggleStatusCard-tgrs2wTg.js";import{i as A}from"./matchTypes--uN0rjmL.js";import{F as Z,R as O,c as ee,d as ie}from"./TextMaxLine-Gfx5-7AO.js";import"./transition-Uc7vb3zK.js";import"./crypto-4w0xa2KF.js";import"./cardsAdapter-AGEHEOqC.js";import"./formatTime-6Hp-6rfJ.js";import"./cardMovementsAdapter-8Omoo-W_.js";import"./UploadSingleFile-hU4ONxup.js";const ae=async a=>{const{data:t}=await G.post("/api/card/add/receipt",a);return t},se=(a={})=>{const t=V(),i=w({mutationFn:ae,...a});return{...i,mutate:async(d,h)=>{const{onSuccess:c,onError:n,...g}=h;try{await E.promise(i.mutateAsync(d,g),{pending:"Comprobando movimientos ...",success:{render({data:r}){return t.invalidateQueries([Y.MOVEMENTS]),t.invalidateQueries([J.CARD_MOVEMENTS]),A(c)&&c(r),"Se creó la comprobación con éxito"}}})}catch(r){const u=K(r,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");A(n)&&n(u),E.error(u,{type:X(r)})}}}};N(v)(({theme:a})=>({"& td":{paddingTop:a.spacing(.5),paddingBottom:a.spacing(.5)}}));const D=({movements:a=[]})=>{const t=P.useMemo(()=>a==null?void 0:a.reduce((i,o)=>{const d=o!=null&&o.amount?o==null?void 0:o.amount:0;return isNaN(d)?i:i+d},0),[a]);return e.jsxs(e.Fragment,{children:[e.jsx(B,{sx:{maxHeight:400},children:e.jsx(I,{sx:{minWidth:200},children:e.jsxs(L,{children:[e.jsx(q,{sx:{borderBottom:i=>`solid 1px ${i.palette.divider}`},children:e.jsxs(v,{children:[e.jsx(p,{width:40,children:"#"}),e.jsx(p,{sx:{minWidth:150},align:"left",children:"Movimiento"}),e.jsx(p,{align:"left",children:"Fecha"}),e.jsx(p,{align:"right",children:"Monto"})]})}),e.jsx($,{children:a==null?void 0:a.map((i,o)=>e.jsxs(v,{sx:{borderBottom:d=>`solid 1px ${d.palette.divider}`},children:[e.jsx(p,{children:o+1}),e.jsx(p,{align:"left",children:e.jsx(_,{sx:{maxWidth:200},children:e.jsx(f,{variant:"subtitle2",children:i==null?void 0:i.description})})}),e.jsx(p,{children:e.jsx(f,{variant:"subtitle2",children:i==null?void 0:i.date})}),e.jsx(p,{align:"right",children:R(i==null?void 0:i.amount)})]},o))})]})})}),e.jsx(x,{justifyContent:"flex-end",direction:"row",children:e.jsxs(x,{direction:"row",spacing:2,px:2,children:[e.jsx(f,{variant:"h6",children:"Total"}),e.jsx(f,{variant:"h6",children:R(t)})]})})]})};D.propTypes={movements:S.array};const oe=(a,t)=>{const{files:i,note:o,method:d,singleFile:h}=a,c=d==="invoice",n=new FormData;c&&(i==null||i.forEach(r=>{n.append("files[]",r)})),!c&&h&&n.append("files[]",h);const g=(t==null?void 0:t.map(r=>({...r==null?void 0:r.original})))||[];return n.append("movements",JSON.stringify(g)),n.append("note",o),n.append("isInvoice",c),n},ne=({movements:a=[],onSuccess:t})=>{const{mutate:i,isLoading:o}=se(),d=U().shape({note:F().when(["method","singleFile"],{is:(s,l)=>s!=="invoice"&&!l,then:s=>s.trim().required("La nota es requerida cuando no existe un archivo."),otherwise:s=>F()}),method:F(),files:M().when("method",{is:"invoice",then:s=>s.max(2,"Cargar máximo 2 archivos por factura.").test("fileFormat","Se requiere el archivo PDF y XML de la factura.",function(l){const m=l.filter(y=>y.type==="application/pdf").length,j=l.filter(y=>["text/xml","application/xml"].includes(y.type)).length;return m===1&&j===1}),otherwise:s=>M()}),singleFile:b().when("method",{is:s=>s!=="invoice",then:s=>s.when(["method","note"],{is:(l,m)=>l!=="invoice"&&!m,then:l=>l.required("El archivo es requerido cuando no hay una nota."),otherwise:l=>b().nullable()}),otherwise:s=>b().nullable()})}),h=H({initialValues:{note:"",method:"invoice",files:[],singleFile:null},validationSchema:d,onSubmit:(s,{setSubmitting:l,setFieldValue:m})=>{const j=oe(s,a);i(j,{onSuccess:()=>{t(),l(!1)},onError:()=>{m("files",[]),m("singleFile",null),l(!1)}})}}),{values:c,setFieldValue:n,setTouched:g,isSubmitting:r}=h,u=c.method==="invoice";return e.jsxs(B,{containerProps:{sx:{flexGrow:0,height:"auto"}},children:[e.jsx(D,{movements:a}),e.jsx(Z,{formik:h,children:e.jsxs(x,{spacing:2,sx:{p:3},children:[e.jsx(x,{children:e.jsxs(Q,{disabled:o,children:[e.jsx(W,{id:"demo-row-radio-buttons-group-label",children:" Seleccione el método de comprobación:"}),e.jsxs(k,{value:c.method,onChange:s=>{n("method",s.target.value),n("files",[]),n("singleFile",null),g({},!1)},row:!0,"aria-labelledby":"demo-row-radio-buttons-group-label",name:"row-radio-buttons-group",children:[e.jsx(T,{value:"invoice",control:e.jsx(C,{}),label:"Factura (XML y PDF)"}),e.jsx(T,{value:"image",control:e.jsx(C,{}),label:"Nota o archivo (Imagen o PDF)"})]})]})}),!u&&e.jsxs(x,{spacing:1,children:[e.jsx(f,{paragraph:!0,variant:"overline",sx:{color:"text.disabled"},children:"Nota:"}),e.jsx(O,{name:"note",multiline:!0,rows:1,placeholder:"Motivo de la comprobación..."})]}),e.jsxs(x,{spacing:1,children:[e.jsx(f,{variant:"overline",sx:{color:"text.disabled",width:1},children:"Archivos (Max - 3MB):"}),u?e.jsx(ee,{name:"files",maxSize:3145728,accept:{"application/pdf":[".pdf"],"application/xml":[".xml"],"text/xml":[".xml"]},...u?{maxFiles:2}:{}}):e.jsx(ie,{name:"singleFile",maxSize:3145728,accept:{"image/*":[".jpeg",".jpg",".png"],"application/pdf":[".pdf"]}})]}),e.jsx(x,{sx:{pt:1},children:e.jsx(z,{loading:o||r,variant:"contained",color:"primary",fullWidth:!0,type:"submit",children:"Comprobar"})})]})})]})};ne.propTypes={movements:S.array,onSuccess:S.func};export{ne as default};
//# sourceMappingURL=VerifyExpensesForm-JvbkDgOw.js.map
