import{al as N,k as V,a as q,Q as E,g as w,b as L,q as I,O as b,r as P,j as e,D as A,B as $,T as f,S as h,L as _}from"./index-bz0JfzWC.js";import{u as k}from"./build-gHVnTrfc.js";import{c as Q,a as y,b as T,g as v}from"./build-2drhUnPq.js";import{f as C}from"./build--iAdUT6r.js";import{t as S,T as W,q as z,s as H,u as p,v as G,R as M}from"./build-AZMH2dGi.js";import{D as K}from"./build-0ASo85PW.js";import{C as U}from"./build-qjKQWaxY.js";import{i as R}from"./build-2m0IIqS0.js";import{F as X,R as Y,c as J}from"./build-UIJPclv6.js";import{R as Z}from"./build-tG3lYJF_.js";import{F as O,q as ee}from"./build-JnDA2kJ8.js";import{R as ie}from"./build-PTX4RFrZ.js";import{F as D}from"./build-LcHoFEF6.js";import"./build-vUCIxQMA.js";import"./build-WQmC1XzH.js";import"./build-kexvEVEW.js";import"./build-4NsTR_M5.js";import"./build-ZTcLKyR-.js";import"./build-FgzbiAP4.js";import"./build-cHqgJp4i.js";import"./build-1DdlkYHZ.js";import"./build-J55YvdEr.js";import"./build-Uc7vb3zK.js";const ae=async a=>{const{data:r}=await N.post("/api/card/add/receipt",a);return r},oe=(a={})=>{const r=V(),i=q({mutationFn:ae,...a});return{...i,mutate:async(c,m)=>{const{onSuccess:d,onError:t,...g}=m;try{await E.promise(i.mutateAsync(c,g),{pending:"Comprobando movimientos ...",success:{render({data:n}){return r.invalidateQueries([K.MOVEMENTS]),r.invalidateQueries([U.CARD_MOVEMENTS]),R(d)&&d(n),"Se creó la comprobación con éxito"}}})}catch(n){const x=w(n,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");R(t)&&t(x),E.error(x,{type:L(n)})}}}};I(S)(({theme:a})=>({"& td":{paddingTop:a.spacing(.5),paddingBottom:a.spacing(.5)}}));const B=({movements:a=[]})=>{const r=P.useMemo(()=>a==null?void 0:a.reduce((i,s)=>{const c=s!=null&&s.amount?s==null?void 0:s.amount:0;return isNaN(c)?i:i+c},0),[a]);return e.jsxs(e.Fragment,{children:[e.jsx(A,{sx:{maxHeight:400},children:e.jsx(W,{sx:{minWidth:200},children:e.jsxs(z,{children:[e.jsx(H,{sx:{borderBottom:i=>`solid 1px ${i.palette.divider}`},children:e.jsxs(S,{children:[e.jsx(p,{width:40,children:"#"}),e.jsx(p,{sx:{minWidth:150},align:"left",children:"Movimiento"}),e.jsx(p,{align:"left",children:"Fecha"}),e.jsx(p,{align:"right",children:"Monto"})]})}),e.jsx(G,{children:a==null?void 0:a.map((i,s)=>e.jsxs(S,{sx:{borderBottom:c=>`solid 1px ${c.palette.divider}`},children:[e.jsx(p,{children:s+1}),e.jsx(p,{align:"left",children:e.jsx($,{sx:{maxWidth:200},children:e.jsx(f,{variant:"subtitle2",children:i==null?void 0:i.description})})}),e.jsx(p,{children:e.jsx(f,{variant:"subtitle2",children:i==null?void 0:i.date})}),e.jsx(p,{align:"right",children:C(i==null?void 0:i.amount)})]},s))})]})})}),e.jsx(h,{justifyContent:"flex-end",direction:"row",children:e.jsxs(h,{direction:"row",spacing:2,px:2,children:[e.jsx(f,{variant:"h6",children:"Total"}),e.jsx(f,{variant:"h6",children:C(r)})]})})]})};B.propTypes={movements:b.array};const se=(a,r)=>{const{files:i,note:s,method:c,singleFile:m}=a,d=c==="invoice",t=new FormData;d&&(i==null||i.forEach(n=>{t.append("files[]",n)})),!d&&m&&t.append("files[]",m);const g=(r==null?void 0:r.map(n=>({...n==null?void 0:n.original})))||[];return t.append("movements",JSON.stringify(g)),t.append("note",s),t.append("isInvoice",d),t},te=({movements:a=[],onSuccess:r})=>{const{mutate:i,isLoading:s}=oe(),c=Q().shape({note:y().when(["method","singleFile"],{is:(o,l)=>o!=="invoice"&&!l,then:o=>o.trim().required("La nota es requerida cuando no existe un archivo."),otherwise:o=>y()}),method:y(),files:T().when("method",{is:"invoice",then:o=>o.max(2,"Cargar máximo 2 archivos por factura.").test("fileFormat","Se requiere el archivo PDF y XML de la factura.",function(l){const u=l.filter(F=>F.type==="application/pdf").length,j=l.filter(F=>["text/xml","application/xml"].includes(F.type)).length;return u===1&&j===1}),otherwise:o=>T()}),singleFile:v().when("method",{is:o=>o!=="invoice",then:o=>o.when(["method","note"],{is:(l,u)=>l!=="invoice"&&!u,then:l=>l.required("El archivo es requerido cuando no hay una nota."),otherwise:l=>v().nullable()}),otherwise:o=>v().nullable()})}),m=k({initialValues:{note:"",method:"invoice",files:[],singleFile:null},validationSchema:c,onSubmit:(o,{setSubmitting:l,setFieldValue:u})=>{const j=se(o,a);i(j,{onSuccess:()=>{r(),l(!1)},onError:()=>{u("files",[]),u("singleFile",null),l(!1)}})}}),{values:d,setFieldValue:t,setTouched:g,isSubmitting:n}=m,x=d.method==="invoice";return e.jsxs(A,{containerProps:{sx:{flexGrow:0,height:"auto"}},children:[e.jsx(B,{movements:a}),e.jsx(X,{formik:m,children:e.jsxs(h,{spacing:2,sx:{p:3},children:[e.jsx(h,{children:e.jsxs(O,{disabled:s,children:[e.jsx(ee,{id:"demo-row-radio-buttons-group-label",children:" Seleccione el método de comprobación:"}),e.jsxs(ie,{value:d.method,onChange:o=>{t("method",o.target.value),t("files",[]),t("singleFile",null),g({},!1)},row:!0,"aria-labelledby":"demo-row-radio-buttons-group-label",name:"row-radio-buttons-group",children:[e.jsx(D,{value:"invoice",control:e.jsx(M,{}),label:"Factura (XML y PDF)"}),e.jsx(D,{value:"image",control:e.jsx(M,{}),label:"Nota o archivo (Imagen o PDF)"})]})]})}),!x&&e.jsxs(h,{spacing:1,children:[e.jsx(f,{paragraph:!0,variant:"overline",sx:{color:"text.disabled"},children:"Nota:"}),e.jsx(Z,{name:"note",multiline:!0,rows:1,placeholder:"Motivo de la comprobación..."})]}),e.jsxs(h,{spacing:1,children:[e.jsx(f,{variant:"overline",sx:{color:"text.disabled",width:1},children:"Archivos (Max - 3MB):"}),x?e.jsx(Y,{name:"files",maxSize:3145728,accept:{"application/pdf":[".pdf"],"application/xml":[".xml"],"text/xml":[".xml"]},...x?{maxFiles:2}:{}}):e.jsx(J,{name:"singleFile",maxSize:3145728,accept:{"image/*":[".jpeg",".jpg",".png"],"application/pdf":[".pdf"]}})]}),e.jsx(h,{sx:{pt:1},children:e.jsx(_,{loading:s||n,variant:"contained",color:"primary",fullWidth:!0,type:"submit",children:"Comprobar"})})]})})]})};te.propTypes={movements:b.array,onSuccess:b.func};export{te as default};
