import{r as y,ar as B,c9 as w,b4 as I,cc as L,j as e,ap as N,ai as _,k,a as G,Q as E,g as $,b as W,q as H,O as R,D as q,B as Q,T as F,S as g,L as z}from"./index-346c4534.js";import{u as K}from"./build-31883e00.js";import{c as U,a as b,d as T,g as S}from"./build-737c64c4.js";import{f as M}from"./build-cb0e7475.js";import{R as X,q as Y,m as C,T as J,k as Z,l as O,n as x,o as ee,r as V}from"./build-6a6f2775.js";import{D as ae}from"./build-643b05e8.js";import{C as ie}from"./build-c7ce8ef2.js";import{i as D}from"./build-f0d75a0c.js";import{F as oe,R as te,c as se}from"./build-1db93dc8.js";import{R as ne}from"./build-d933afe7.js";import{F as re,q as le}from"./build-6435c1fd.js";import{F as P}from"./build-f8f5ccb1.js";import"./build-9177a231.js";import"./build-40e523c6.js";import"./build-24563a1e.js";import"./build-f149ac76.js";import"./build-6471b759.js";import"./build-a20336ff.js";import"./build-4fa429fc.js";import"./build-2a2c9560.js";import"./build-e9361a90.js";import"./build-6cc29a6e.js";import"./build-bee6630b.js";const ce=["actions","children","defaultValue","name","onChange","value"],de=y.forwardRef(function(n,a){const{actions:t,children:c,defaultValue:u,name:d,onChange:s,value:f}=n,l=B(n,ce),p=y.useRef(null),[o,r]=w({controlled:f,default:u,name:"RadioGroup"});y.useImperativeHandle(t,()=>({focus:()=>{let m=p.current.querySelector("input:not(:disabled):checked");m||(m=p.current.querySelector("input:not(:disabled)")),m&&m.focus()}}),[]);const h=I(a,p),j=L(d),v=y.useMemo(()=>({name:j,onChange(m){r(m.target.value),s&&s(m,m.target.value)},value:o}),[j,s,r,o]);return e.jsx(X.Provider,{value:v,children:e.jsx(Y,N({role:"radiogroup",ref:h},l,{children:c}))})}),pe=de,ue=async i=>{const{data:n}=await _.post("/api/card/add/receipt",i);return n},he=(i={})=>{const n=k(),a=G({mutationFn:ue,...i});return{...a,mutate:async(c,u)=>{const{onSuccess:d,onError:s,...f}=u;try{await E.promise(a.mutateAsync(c,f),{pending:"Comprobando movimientos ...",success:{render({data:l}){return n.invalidateQueries([ae.MOVEMENTS]),n.invalidateQueries([ie.CARD_MOVEMENTS]),D(d)&&d(l),"Se creó la comprobación con éxito"}}})}catch(l){const p=$(l,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");D(s)&&s(p),E.error(p,{type:W(l)})}}}};H(C)(({theme:i})=>({"& td":{paddingTop:i.spacing(.5),paddingBottom:i.spacing(.5)}}));const A=({movements:i=[]})=>{const n=y.useMemo(()=>i==null?void 0:i.reduce((a,t)=>{const c=t!=null&&t.amount?t==null?void 0:t.amount:0;return isNaN(c)?a:a+c},0),[i]);return e.jsxs(e.Fragment,{children:[e.jsx(q,{sx:{maxHeight:400},children:e.jsx(J,{sx:{minWidth:200},children:e.jsxs(Z,{children:[e.jsx(O,{sx:{borderBottom:a=>`solid 1px ${a.palette.divider}`},children:e.jsxs(C,{children:[e.jsx(x,{width:40,children:"#"}),e.jsx(x,{sx:{minWidth:150},align:"left",children:"Movimiento"}),e.jsx(x,{align:"left",children:"Fecha"}),e.jsx(x,{align:"right",children:"Monto"})]})}),e.jsx(ee,{children:i==null?void 0:i.map((a,t)=>e.jsxs(C,{sx:{borderBottom:c=>`solid 1px ${c.palette.divider}`},children:[e.jsx(x,{children:t+1}),e.jsx(x,{align:"left",children:e.jsx(Q,{sx:{maxWidth:200},children:e.jsx(F,{variant:"subtitle2",children:a==null?void 0:a.description})})}),e.jsx(x,{children:e.jsx(F,{variant:"subtitle2",children:a==null?void 0:a.date})}),e.jsx(x,{align:"right",children:M(a==null?void 0:a.amount)})]},t))})]})})}),e.jsx(g,{justifyContent:"flex-end",direction:"row",children:e.jsxs(g,{direction:"row",spacing:2,px:2,children:[e.jsx(F,{variant:"h6",children:"Total"}),e.jsx(F,{variant:"h6",children:M(n)})]})})]})};A.propTypes={movements:R.array};const me=(i,n)=>{const{files:a,note:t,method:c,singleFile:u}=i,d=c==="invoice",s=new FormData;d&&(a==null||a.forEach(l=>{s.append("files[]",l)})),!d&&u&&s.append("files[]",u);const f=(n==null?void 0:n.map(l=>({...l==null?void 0:l.original})))||[];return s.append("movements",JSON.stringify(f)),s.append("note",t),s.append("isInvoice",d),s},xe=({movements:i=[],onSuccess:n})=>{const{mutate:a,isLoading:t}=he(),c=U().shape({note:b().when(["method","singleFile"],{is:(o,r)=>o!=="invoice"&&!r,then:o=>o.trim().required("La nota es requerida cuando no existe un archivo."),otherwise:o=>b()}),method:b(),files:T().when("method",{is:"invoice",then:o=>o.max(2,"Cargar máximo 2 archivos por factura.").test("fileFormat","Se requiere el archivo PDF y XML de la factura.",function(r){const h=r.filter(v=>v.type==="application/pdf").length,j=r.filter(v=>["text/xml","application/xml"].includes(v.type)).length;return h===1&&j===1}),otherwise:o=>T()}),singleFile:S().when("method",{is:o=>o!=="invoice",then:o=>o.when(["method","note"],{is:(r,h)=>r!=="invoice"&&!h,then:r=>r.required("El archivo es requerido cuando no hay una nota."),otherwise:r=>S().nullable()}),otherwise:o=>S().nullable()})}),u=K({initialValues:{note:"",method:"invoice",files:[],singleFile:null},validationSchema:c,onSubmit:(o,{setSubmitting:r,setFieldValue:h})=>{const j=me(o,i);a(j,{onSuccess:()=>{n(),r(!1)},onError:()=>{h("files",[]),h("singleFile",null),r(!1)}})}}),{values:d,setFieldValue:s,setTouched:f,isSubmitting:l}=u,p=d.method==="invoice";return e.jsxs(q,{containerProps:{sx:{flexGrow:0,height:"auto"}},children:[e.jsx(A,{movements:i}),e.jsx(oe,{formik:u,children:e.jsxs(g,{spacing:2,sx:{p:3},children:[e.jsx(g,{children:e.jsxs(re,{disabled:t,children:[e.jsx(le,{id:"demo-row-radio-buttons-group-label",children:" Seleccione el método de comprobación:"}),e.jsxs(pe,{value:d.method,onChange:o=>{s("method",o.target.value),s("files",[]),s("singleFile",null),f({},!1)},row:!0,"aria-labelledby":"demo-row-radio-buttons-group-label",name:"row-radio-buttons-group",children:[e.jsx(P,{value:"invoice",control:e.jsx(V,{}),label:"Factura (XML y PDF)"}),e.jsx(P,{value:"image",control:e.jsx(V,{}),label:"Nota o archivo (Imagen o PDF)"})]})]})}),!p&&e.jsxs(g,{spacing:1,children:[e.jsx(F,{paragraph:!0,variant:"overline",sx:{color:"text.disabled"},children:"Nota:"}),e.jsx(ne,{name:"note",multiline:!0,rows:1,placeholder:"Motivo de la comprobación..."})]}),e.jsxs(g,{spacing:1,children:[e.jsx(F,{variant:"overline",sx:{color:"text.disabled",width:1},children:"Archivos (Max - 3MB):"}),p?e.jsx(te,{name:"files",maxSize:3145728,accept:{"application/pdf":[".pdf"],"application/xml":[".xml"],"text/xml":[".xml"]},...p?{maxFiles:2}:{}}):e.jsx(se,{name:"singleFile",maxSize:3145728,accept:{"image/*":[".jpeg",".jpg",".png"],"application/pdf":[".pdf"]}})]}),e.jsx(g,{sx:{pt:1},children:e.jsx(z,{loading:t||l,variant:"contained",color:"primary",fullWidth:!0,type:"submit",children:"Comprobar"})})]})})]})};xe.propTypes={movements:R.array,onSuccess:R.func};export{xe as default};
