import{Y as R,g as V,a as v,L as A,_ as I,i as Q}from"./index-BioQLkmz.js";import{c as b,f as K,bg as C,a9 as w,r as S,i as d,e6 as j,S as D,X as z,P as g}from"./vendor-CEMfbhOc.js";import{u as U}from"./formik.esm-Dshy1xjd.js";import{c as $,a as B,d as G}from"./index.esm-C2GVbld4.js";import{i as M}from"./matchTypes-BFKCRNnN.js";import{T}from"./tickets-support-list-keys-S53qn0fN.js";import{a as Y}from"./SupportIncidences-CzHvEnJg.js";import"./TextMaxLine-Ca-IUWEV.js";import"./formatTime-mlJJpQBT.js";import"./MaterialDataTable-D0DjFiDf.js";import"./useMaterialTable-9wOa4uxn.js";import"./HeaderPage-BO6m0cK6.js";import"./fade-CViozI82.js";import"./transition-anLY3gj9.js";import"./UploadSingleFile-DmSrCqqJ.js";import"./formatNumber-Df8NwpjV.js";const X=(i,a,n)=>{const{message:r,attachments:e}=a,s=new FormData;s.append("message",r),s.append("ticketId",i),e==null||e.forEach(m=>{s.append("files[]",m)});const o=new Date().toLocaleString(),l=window.crypto||window.msCrypto,u=new Uint32Array(1),c={id:l.getRandomValues(u)[0],name:n==null?void 0:n.name,initials:R((n==null?void 0:n.name)||""),message:r,createDate:{fToNow:"justo ahora",original:o},my:!0,attachment:e||[],avatar:r!=null&&r.photo&&(r==null?void 0:r.photo)!==""?r==null?void 0:r.photo:"/",isSent:!1};return{data:s,ticketId:i,optimistic:c}},H=(i={})=>{const a=b(),n=K({mutationFn:Y,onMutate:async e=>{const s=[T.TICKET_CONVERSATION,e==null?void 0:e.ticketId];await a.cancelQueries({queryKey:s});const o=a.getQueryData(s);return a.setQueryData(s,l=>{const u=l.pages.flat().map(t=>{var E,_;return{...t,results:{participants:((E=t==null?void 0:t.results)==null?void 0:E.participants)||[],messages:[e==null?void 0:e.optimistic,...(_=t==null?void 0:t.results)==null?void 0:_.messages]}}}),c=C.chunk(u,10);return{pageParams:[void 0,...c.slice(0,-1).map(t=>t.at(-1).createdAt)],pages:c.flat()}}),{previousMessages:o}},onError:(e,s,o)=>{a.setQueryData([T.TICKET_CONVERSATION,s==null?void 0:s.ticketId],o.previousMessages)},onSettled:(e,s,o,l)=>{a.invalidateQueries({queryKey:[T.TICKET_CONVERSATION,o==null?void 0:o.ticketId]})},...i});return{...n,mutate:async(e,s)=>{const{onSuccess:o,onError:l,...u}=s;try{await w.promise(n.mutateAsync(e,u),{pending:"Agregando Mensaje al Ticket...",success:{render({data:c}){return M(o)&&o(c),"Se envió el mensaje con éxito"}}}),a.invalidateQueries([T.ASSIGNED_LIST]),a.invalidateQueries([T.GENERATED_LIST])}catch(c){const m=V(c,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");M(l)&&l(m),w.error(m,{type:v(c)})}}}},J=A(S.lazy(()=>I(()=>import("./TicketMessages-CZMuZ3e0.js"),__vite__mapDeps([0,1,2,3,4])))),W=A(S.lazy(()=>I(()=>import("./TicketAddAttachmentFiles-KI7NaoHj.js"),__vite__mapDeps([5,1,2,3,4])))),Z=A(S.lazy(()=>I(()=>import("./TicketMessageInput-CQ_wF9nh.js"),__vite__mapDeps([6,1,7])))),k=({ticket:i,queryTicketConversation:a})=>{var x;const{mutate:n,isLoading:r}=H(),e=Q(),[s,o]=S.useState(!1),l=$().shape({message:B().required("El mensaje es requerido"),attachments:G()}),u=U({validateOnChange:!1,enableReinitialize:!1,initialValues:{message:"",attachments:[]},validationSchema:l,onSubmit:(h,{setSubmitting:p,resetForm:f})=>{const O=X(i==null?void 0:i.id,h,e);n(O,{onSuccess:()=>{p(!1),f()},onError:()=>{p(!1)}})}}),{handleSubmit:c,isSubmitting:m,values:t,setFieldValue:E,validateForm:_}=u,y=m||r,F=h=>{const p=Array.from(h.target.files);E("attachments",[...p,...t.attachments])},L=h=>{var p;E("attachments",(p=t==null?void 0:t.attachments)==null?void 0:p.filter(f=>f!==h))},N=async h=>{var f;h.preventDefault(),o(!0);const p=await _();p&&((f=Object.keys(p))==null?void 0:f.length)>0&&(window.scrollTo(0,0),w.warn("Verifique todos los campos obligatorios")),c()},P=S.useMemo(()=>t==null?void 0:t.attachments,[t==null?void 0:t.attachments]);return d.jsxs(d.Fragment,{children:[(a==null?void 0:a.isFetching)&&d.jsx(j,{}),d.jsx(D,{sx:{overflow:"hidden"},children:d.jsx(J,{queryTicketConversation:a,scroll:s,setScroll:o})}),d.jsxs(D,{flex:1,justifyContent:"flex-end",children:[(a==null?void 0:a.isFetching)&&d.jsx(j,{}),d.jsx(z,{}),!y&&d.jsx(W,{files:P,isLoading:y,handleRemoveFile:L}),((x=i==null?void 0:i.status)==null?void 0:x.id)!=="3"&&d.jsx(Z,{formik:u,isLoading:y,handleAddMessage:N,handleFileChange:F})]})]})};k.propTypes={queryTicketConversation:g.shape({isFetching:g.any}),ticket:g.shape({id:g.any,status:g.shape({id:g.string})})};export{k as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/js/TicketMessages-CZMuZ3e0.js","assets/js/vendor-CEMfbhOc.js","assets/js/index-BioQLkmz.js","assets/css/build-B8cqXs1n.css","assets/js/getFileFormat-1mdVNW85.js","assets/js/TicketAddAttachmentFiles-KI7NaoHj.js","assets/js/TicketMessageInput-CQ_wF9nh.js","assets/js/formik.esm-Dshy1xjd.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=TicketConversationLayout-CpSCplxr.js.map
