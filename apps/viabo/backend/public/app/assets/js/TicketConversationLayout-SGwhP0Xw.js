import{Y as O,g as R,a as V,L as A,_ as x,i as v}from"./index-mKe_odg3.js";import{c as Q,f as b,bh as K,a9 as y,r as _,i as c,e0 as D,V as j,X as z,P as S}from"./vendor-StReGf79.js";import{u as C}from"./formik.esm-ayHIcoJR.js";import{c as k,a as U,d as $}from"./index.esm-cYP9oANf.js";import{i as w}from"./matchTypes-VzXr5CmM.js";import{T}from"./tickets-support-list-keys-ThL685Ct.js";import{a as G}from"./SupportIncidences-TWCHxZXW.js";import"./TextMaxLine-Nybdgfc_.js";import"./formatTime-j4oUQxO9.js";import"./HeaderPage-fCD0eWYY.js";import"./fade-HpdRXKiE.js";import"./transition-Uc7vb3zK.js";import"./useMaterialTable-3iMRnh5c.js";import"./UploadSingleFile-NVjHNA2_.js";import"./formatNumber-D2wM-uoj.js";const Y=(l,e,r)=>{const{message:i,attachments:a}=e,s=new FormData;s.append("message",i),s.append("ticketId",l),a==null||a.forEach(u=>{s.append("files[]",u)});const o=new Date().toLocaleString(),p={id:self.crypto.randomUUID(),name:r==null?void 0:r.name,initials:O((r==null?void 0:r.name)||""),message:i,createDate:{fToNow:"justo ahora",original:o},my:!0,attachment:a||[],avatar:i!=null&&i.photo&&(i==null?void 0:i.photo)!==""?i==null?void 0:i.photo:"/",isSent:!1};return{data:s,ticketId:l,optimistic:p}},B=(l={})=>{const e=Q(),r=b({mutationFn:G,onMutate:async a=>{const s=[T.TICKET_CONVERSATION,a==null?void 0:a.ticketId];await e.cancelQueries({queryKey:s});const o=e.getQueryData(s);return e.setQueryData(s,p=>{const u=p.pages.flat().map(t=>{var E,g;return{...t,results:{participants:((E=t==null?void 0:t.results)==null?void 0:E.participants)||[],messages:[a==null?void 0:a.optimistic,...(g=t==null?void 0:t.results)==null?void 0:g.messages]}}}),d=K.chunk(u,10);return{pageParams:[void 0,...d.slice(0,-1).map(t=>t.at(-1).createdAt)],pages:d.flat()}}),{previousMessages:o}},onError:(a,s,o)=>{e.setQueryData([T.TICKET_CONVERSATION,s==null?void 0:s.ticketId],o.previousMessages)},onSettled:(a,s,o,p)=>{e.invalidateQueries({queryKey:[T.TICKET_CONVERSATION,o==null?void 0:o.ticketId]})},...l});return{...r,mutate:async(a,s)=>{const{onSuccess:o,onError:p,...u}=s;try{await y.promise(r.mutateAsync(a,u),{pending:"Agregando Mensaje al Ticket...",success:{render({data:d}){return w(o)&&o(d),"Se envió el mensaje con éxito"}}}),e.invalidateQueries([T.ASSIGNED_LIST]),e.invalidateQueries([T.GENERATED_LIST])}catch(d){const h=R(d,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");w(p)&&p(h),y.error(h,{type:V(d)})}}}},X=A(_.lazy(()=>x(()=>import("./TicketMessages-C4jgP2AP.js"),__vite__mapDeps([0,1,2,3,4])))),H=A(_.lazy(()=>x(()=>import("./TicketAddAttachmentFiles-n3kLXAzL.js"),__vite__mapDeps([5,1,2,3,4])))),J=A(_.lazy(()=>x(()=>import("./TicketMessageInput-1-0L5fbJ.js"),__vite__mapDeps([6,1,7])))),W=({ticket:l,queryTicketConversation:e})=>{const{mutate:r,isLoading:i}=B(),a=v(),[s,o]=_.useState(!1),p=k().shape({message:U().required("El mensaje es requerido"),attachments:$()}),u=C({validateOnChange:!1,enableReinitialize:!1,initialValues:{message:"",attachments:[]},validationSchema:p,onSubmit:(m,{setSubmitting:n,resetForm:f})=>{const P=Y(l==null?void 0:l.id,m,a);r(P,{onSuccess:()=>{n(!1),f()},onError:()=>{n(!1)}})}}),{handleSubmit:d,isSubmitting:h,values:t,setFieldValue:E,validateForm:g}=u,I=h||i,M=m=>{const n=Array.from(m.target.files);E("attachments",[...n,...t.attachments])},F=m=>{var n;E("attachments",(n=t==null?void 0:t.attachments)==null?void 0:n.filter(f=>f!==m))},L=async m=>{var f;m.preventDefault(),o(!0);const n=await g();n&&((f=Object.keys(n))==null?void 0:f.length)>0&&(window.scrollTo(0,0),y.warn("Verifique todos los campos obligatorios")),d()},N=_.useMemo(()=>t==null?void 0:t.attachments,[t==null?void 0:t.attachments]);return c.jsxs(c.Fragment,{children:[(e==null?void 0:e.isFetching)&&c.jsx(D,{}),c.jsx(j,{sx:{overflow:"hidden"},children:c.jsx(X,{queryTicketConversation:e,scroll:s,setScroll:o})}),c.jsxs(j,{flex:1,justifyContent:"flex-end",children:[(e==null?void 0:e.isFetching)&&c.jsx(D,{}),c.jsx(z,{}),!I&&c.jsx(H,{files:N,isLoading:I,handleRemoveFile:F}),c.jsx(J,{formik:u,isLoading:I,handleAddMessage:L,handleFileChange:M})]})]})};W.propTypes={queryTicketConversation:S.shape({isFetching:S.any}),ticket:S.shape({id:S.any})};export{W as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/js/TicketMessages-C4jgP2AP.js","assets/js/vendor-StReGf79.js","assets/js/index-mKe_odg3.js","assets/css/build-K0YT2apu.css","assets/js/getFileFormat-7MwSnboB.js","assets/js/TicketAddAttachmentFiles-n3kLXAzL.js","assets/js/TicketMessageInput-1-0L5fbJ.js","assets/js/formik.esm-ayHIcoJR.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=TicketConversationLayout-SGwhP0Xw.js.map
