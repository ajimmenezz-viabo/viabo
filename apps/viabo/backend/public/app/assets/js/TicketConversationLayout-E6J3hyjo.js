import{Y as R,g as V,a as v,L as A,_ as I,i as Q}from"./index-8BLzEq8l.js";import{c as b,f as K,bh as C,a9 as w,r as _,i as p,e0 as j,V as D,X as z,P as E}from"./vendor-StReGf79.js";import{u as U}from"./formik.esm-ayHIcoJR.js";import{c as $,a as G,d as Y}from"./index.esm-cYP9oANf.js";import{i as M}from"./matchTypes-VzXr5CmM.js";import{T}from"./tickets-support-list-keys-ThL685Ct.js";import{a as B}from"./SupportIncidences-0QpMl_25.js";import"./TextMaxLine-9O-T-qdR.js";import"./formatTime-j4oUQxO9.js";import"./HeaderPage-Oxll9yW3.js";import"./fade-HpdRXKiE.js";import"./transition-Uc7vb3zK.js";import"./useMaterialTable-3iMRnh5c.js";import"./UploadSingleFile-IuSqpHgf.js";import"./formatNumber-D2wM-uoj.js";const X=(i,a,n)=>{const{message:r,attachments:e}=a,s=new FormData;s.append("message",r),s.append("ticketId",i),e==null||e.forEach(m=>{s.append("files[]",m)});const o=new Date().toLocaleString(),l=window.crypto||window.msCrypto,u=new Uint32Array(1),c={id:l.getRandomValues(u)[0],name:n==null?void 0:n.name,initials:R((n==null?void 0:n.name)||""),message:r,createDate:{fToNow:"justo ahora",original:o},my:!0,attachment:e||[],avatar:r!=null&&r.photo&&(r==null?void 0:r.photo)!==""?r==null?void 0:r.photo:"/",isSent:!1};return{data:s,ticketId:i,optimistic:c}},H=(i={})=>{const a=b(),n=K({mutationFn:B,onMutate:async e=>{const s=[T.TICKET_CONVERSATION,e==null?void 0:e.ticketId];await a.cancelQueries({queryKey:s});const o=a.getQueryData(s);return a.setQueryData(s,l=>{const u=l.pages.flat().map(t=>{var g,S;return{...t,results:{participants:((g=t==null?void 0:t.results)==null?void 0:g.participants)||[],messages:[e==null?void 0:e.optimistic,...(S=t==null?void 0:t.results)==null?void 0:S.messages]}}}),c=C.chunk(u,10);return{pageParams:[void 0,...c.slice(0,-1).map(t=>t.at(-1).createdAt)],pages:c.flat()}}),{previousMessages:o}},onError:(e,s,o)=>{a.setQueryData([T.TICKET_CONVERSATION,s==null?void 0:s.ticketId],o.previousMessages)},onSettled:(e,s,o,l)=>{a.invalidateQueries({queryKey:[T.TICKET_CONVERSATION,o==null?void 0:o.ticketId]})},...i});return{...n,mutate:async(e,s)=>{const{onSuccess:o,onError:l,...u}=s;try{await w.promise(n.mutateAsync(e,u),{pending:"Agregando Mensaje al Ticket...",success:{render({data:c}){return M(o)&&o(c),"Se envió el mensaje con éxito"}}}),a.invalidateQueries([T.ASSIGNED_LIST]),a.invalidateQueries([T.GENERATED_LIST])}catch(c){const m=V(c,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");M(l)&&l(m),w.error(m,{type:v(c)})}}}},J=A(_.lazy(()=>I(()=>import("./TicketMessages-t-OjfLan.js"),__vite__mapDeps([0,1,2,3,4])))),W=A(_.lazy(()=>I(()=>import("./TicketAddAttachmentFiles-zwCx8VGU.js"),__vite__mapDeps([5,1,2,3,4])))),Z=A(_.lazy(()=>I(()=>import("./TicketMessageInput-1-0L5fbJ.js"),__vite__mapDeps([6,1,7])))),k=({ticket:i,queryTicketConversation:a})=>{var x;const{mutate:n,isLoading:r}=H(),e=Q(),[s,o]=_.useState(!1),l=$().shape({message:G().required("El mensaje es requerido"),attachments:Y()}),u=U({validateOnChange:!1,enableReinitialize:!1,initialValues:{message:"",attachments:[]},validationSchema:l,onSubmit:(h,{setSubmitting:d,resetForm:f})=>{const O=X(i==null?void 0:i.id,h,e);n(O,{onSuccess:()=>{d(!1),f()},onError:()=>{d(!1)}})}}),{handleSubmit:c,isSubmitting:m,values:t,setFieldValue:g,validateForm:S}=u,y=m||r,F=h=>{const d=Array.from(h.target.files);g("attachments",[...d,...t.attachments])},L=h=>{var d;g("attachments",(d=t==null?void 0:t.attachments)==null?void 0:d.filter(f=>f!==h))},N=async h=>{var f;h.preventDefault(),o(!0);const d=await S();d&&((f=Object.keys(d))==null?void 0:f.length)>0&&(window.scrollTo(0,0),w.warn("Verifique todos los campos obligatorios")),c()},P=_.useMemo(()=>t==null?void 0:t.attachments,[t==null?void 0:t.attachments]);return p.jsxs(p.Fragment,{children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(D,{sx:{overflow:"hidden"},children:p.jsx(J,{queryTicketConversation:a,scroll:s,setScroll:o})}),p.jsxs(D,{flex:1,justifyContent:"flex-end",children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(z,{}),!y&&p.jsx(W,{files:P,isLoading:y,handleRemoveFile:L}),((x=i==null?void 0:i.status)==null?void 0:x.id)!=="3"&&p.jsx(Z,{formik:u,isLoading:y,handleAddMessage:N,handleFileChange:F})]})]})};k.propTypes={queryTicketConversation:E.shape({isFetching:E.any}),ticket:E.shape({id:E.any,status:E.shape({id:E.string})})};export{k as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/js/TicketMessages-t-OjfLan.js","assets/js/vendor-StReGf79.js","assets/js/index-8BLzEq8l.js","assets/css/build-K0YT2apu.css","assets/js/getFileFormat-7MwSnboB.js","assets/js/TicketAddAttachmentFiles-zwCx8VGU.js","assets/js/TicketMessageInput-1-0L5fbJ.js","assets/js/formik.esm-ayHIcoJR.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=TicketConversationLayout-E6J3hyjo.js.map
