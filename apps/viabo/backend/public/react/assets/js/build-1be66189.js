import{r as g,aj as B,aV as L,b2 as N,b3 as w,j as e,ah as _,a8 as k,k as q,a as G,Z as R,g as I,b as $,q as W,D as S,a2 as D,B as H,T as j,S as f,L as Q}from"./index-23408dd2.js";import{u as z}from"./build-0d19139b.js";import{c as K,a as F,d as E}from"./build-84a54290.js";import{f as T}from"./build-a1ec3a2c.js";import{R as X,m as Y,T as C,g as J,h as U,i as Z,j as x,k as O,n as M}from"./build-0354e1de.js";import{D as ee}from"./build-49ab0b2d.js";import{C as ae}from"./build-5f0084a1.js";import{i as V}from"./build-bfb17aff.js";import{F as oe,R as ie}from"./build-99db375a.js";import{R as te}from"./build-53b28d89.js";import{F as re,b as se}from"./build-70633a7e.js";import{F as A}from"./build-cb395694.js";import"./build-c875c593.js";import"./build-74a1b13a.js";import"./build-2f111781.js";import"./build-f2ae8137.js";import"./build-980fd41b.js";import"./build-26fbb83b.js";import"./build-9cdd5450.js";import"./build-54e0e54c.js";import"./build-2876f46a.js";import"./build-dedb6d40.js";import"./build-4ba3cb14.js";import"./build-68d1d76d.js";import"./build-bee6630b.js";const ne=["actions","children","defaultValue","name","onChange","value"],le=g.forwardRef(function(t,a){const{actions:i,children:l,defaultValue:d,name:u,onChange:r,value:y}=t,m=B(t,ne),p=g.useRef(null),[v,s]=L({controlled:y,default:d,name:"RadioGroup"});g.useImperativeHandle(i,()=>({focus:()=>{let c=p.current.querySelector("input:not(:disabled):checked");c||(c=p.current.querySelector("input:not(:disabled)")),c&&c.focus()}}),[]);const n=N(a,p),h=w(u),b=g.useMemo(()=>({name:h,onChange(c){s(c.target.value),r&&r(c,c.target.value)},value:v}),[h,r,s,v]);return e.jsx(X.Provider,{value:b,children:e.jsx(Y,_({role:"radiogroup",ref:n},m,{children:l}))})}),de=le,ce=async o=>{const{data:t}=await k.post("/api/card/add/receipt",o);return t},pe=(o={})=>{const t=q(),a=G(ce,o);return{...a,mutate:async(l,d)=>{const{onSuccess:u,onError:r,...y}=d;try{await R.promise(a.mutateAsync(l,y),{pending:"Comprobando movimientos ...",success:{render({data:m}){return t.invalidateQueries([ee.MOVEMENTS]),t.invalidateQueries([ae.CARD_MOVEMENTS]),V(u)&&u(m),"Se creó la comprobación con éxito"}}})}catch(m){const p=I(m,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");V(r)&&r(p),R.error(p,{type:$(m)})}}}};W(C)(({theme:o})=>({"& td":{paddingTop:o.spacing(.5),paddingBottom:o.spacing(.5)}}));const P=({movements:o=[]})=>{const t=g.useMemo(()=>o==null?void 0:o.reduce((a,i)=>{const l=i!=null&&i.amount?i==null?void 0:i.amount:0;return isNaN(l)?a:a+l},0),[o]);return e.jsxs(e.Fragment,{children:[e.jsx(D,{sx:{maxHeight:400},children:e.jsx(J,{sx:{minWidth:200},children:e.jsxs(U,{children:[e.jsx(Z,{sx:{borderBottom:a=>`solid 1px ${a.palette.divider}`},children:e.jsxs(C,{children:[e.jsx(x,{width:40,children:"#"}),e.jsx(x,{sx:{minWidth:150},align:"left",children:"Movimiento"}),e.jsx(x,{align:"left",children:"Fecha"}),e.jsx(x,{align:"right",children:"Monto"})]})}),e.jsx(O,{children:o==null?void 0:o.map((a,i)=>e.jsxs(C,{sx:{borderBottom:l=>`solid 1px ${l.palette.divider}`},children:[e.jsx(x,{children:i+1}),e.jsx(x,{align:"left",children:e.jsx(H,{sx:{maxWidth:200},children:e.jsx(j,{variant:"subtitle2",children:a==null?void 0:a.description})})}),e.jsx(x,{children:e.jsx(j,{variant:"subtitle2",children:a==null?void 0:a.date})}),e.jsx(x,{align:"right",children:T(a==null?void 0:a.amount)})]},i))})]})})}),e.jsx(f,{justifyContent:"flex-end",direction:"row",children:e.jsxs(f,{direction:"row",spacing:2,px:2,children:[e.jsx(j,{variant:"h6",children:"Total"}),e.jsx(j,{variant:"h6",children:T(t)})]})})]})};P.propTypes={movements:S.array};const ue=(o,t)=>{const{files:a,note:i,method:l}=o,d=new FormData;a==null||a.forEach(r=>{d.append("files[]",r)});const u=(t==null?void 0:t.map(r=>({...r==null?void 0:r.original})))||[];return d.append("movements",JSON.stringify(u)),d.append("note",i),d.append("isInvoice",l==="invoice"),d},me=({movements:o=[],onSuccess:t})=>{const{mutate:a,isLoading:i}=pe(),l=K().shape({note:F().when(["method","files"],{is:(s,n)=>s!=="invoice"&&n.length===0,then:s=>s.trim().required("La nota es requerida cuando no existe al menos un archivo."),otherwise:s=>F()}),method:F(),files:E().when("method",{is:"invoice",then:s=>s.max(2,"Cargar máximo 2 archivos por factura.").test("fileFormat","Se requiere el archivo PDF y XML de la factura.",function(n){const h=n.filter(c=>c.type==="application/pdf").length,b=n.filter(c=>["text/xml","application/xml"].includes(c.type)).length;return h===1&&b===1}),otherwise:s=>s.when(["method","note"],{is:(n,h)=>n!=="invoice"&&!h,then:n=>n.min(1,"Al menos un archivo es requerido cuando no hay una nota."),otherwise:n=>E()})})}),d=z({initialValues:{note:"",method:"invoice",files:[]},validationSchema:l,onSubmit:(s,{setSubmitting:n})=>{const h=ue(s,o);a(h,{onSuccess:()=>{t(),n(!1)},onError:()=>{n(!1)}})}}),{values:u,setFieldValue:r,setTouched:y,isSubmitting:m}=d,p=u.method==="invoice",v=g.useMemo(()=>p?{"application/pdf":[".pdf"],"application/xml":[".xml"],"text/xml":[".xml"]}:{"image/*":[".jpeg",".jpg",".png"],"application/pdf":[".pdf"]},[p]);return e.jsxs(D,{containerProps:{sx:{flexGrow:0,height:"auto"}},children:[e.jsx(P,{movements:o}),e.jsx(oe,{formik:d,children:e.jsxs(f,{spacing:2,sx:{p:3},children:[e.jsx(f,{children:e.jsxs(re,{disabled:i,children:[e.jsx(se,{id:"demo-row-radio-buttons-group-label",children:" Seleccione el método de comprobación:"}),e.jsxs(de,{value:u.method,onChange:s=>{r("method",s.target.value),r("files",[]),y({},!1)},row:!0,"aria-labelledby":"demo-row-radio-buttons-group-label",name:"row-radio-buttons-group",children:[e.jsx(A,{value:"invoice",control:e.jsx(M,{}),label:"Factura (XML y PDF)"}),e.jsx(A,{value:"image",control:e.jsx(M,{}),label:"Nota o imagen"})]})]})}),!p&&e.jsxs(f,{children:[e.jsx(j,{paragraph:!0,variant:"overline",sx:{color:"text.disabled"},children:"Nota:"}),e.jsx(te,{name:"note",multiline:!0,rows:1,placeholder:"Motivo de la comprobación..."})]}),e.jsxs(f,{spacing:3,children:[e.jsx(j,{variant:"overline",sx:{color:"text.disabled",width:1},children:"Archivos:"}),e.jsx(ie,{name:"files",maxSize:3145728,accept:v,...p?{maxFiles:2}:{}})]}),e.jsx(f,{sx:{pt:1},children:e.jsx(Q,{loading:i||m,variant:"contained",color:"primary",fullWidth:!0,type:"submit",children:"Comprobar"})})]})})]})};me.propTypes={movements:S.array,onSuccess:S.func};export{me as default};
