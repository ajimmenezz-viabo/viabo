import{W as R,g as V,b as v,L as A,_ as I,j as b}from"./index-Kl2QvVyT.js";import{c as Q,f as K,bd as C,U as w,r as S,i as p,e9 as j,S as D,y as z,P as E}from"./vendor-B39b6gT1.js";import{u as U}from"./formik.esm-CRn2DIxC.js";import{c as $,a as B,d as G}from"./index.esm-DHXyn7Aa.js";import{i as M}from"./matchTypes-E5vQDj-t.js";import{T}from"./tickets-support-list-keys-S53qn0fN.js";import{a as W}from"./SupportIncidences-BjFjodGI.js";import"./TextMaxLine-BvJpBV6_.js";import"./formatTime-DnNoLFDr.js";import"./MaterialDataTable-BLrn9vSy.js";import"./useMaterialTable-BgHRdWwm.js";import"./HeaderPage-CoeRaeoE.js";import"./fade-CViozI82.js";import"./transition-anLY3gj9.js";import"./UploadSingleFile-BV6pleIy.js";import"./formatNumber-Byfz8vD2.js";const Y=(i,a,n)=>{const{message:r,attachments:e}=a,s=new FormData;s.append("message",r),s.append("ticketId",i),e==null||e.forEach(m=>{s.append("files[]",m)});const o=new Date().toLocaleString(),l=window.crypto||window.msCrypto,u=new Uint32Array(1),c={id:l.getRandomValues(u)[0],name:n==null?void 0:n.name,initials:R((n==null?void 0:n.name)||""),message:r,createDate:{fToNow:"justo ahora",original:o},my:!0,attachment:e||[],avatar:r!=null&&r.photo&&(r==null?void 0:r.photo)!==""?r==null?void 0:r.photo:"/",isSent:!1};return{data:s,ticketId:i,optimistic:c}},H=(i={})=>{const a=Q(),n=K({mutationFn:W,onMutate:async e=>{const s=[T.TICKET_CONVERSATION,e==null?void 0:e.ticketId];await a.cancelQueries({queryKey:s});const o=a.getQueryData(s);return a.setQueryData(s,l=>{const u=l.pages.flat().map(t=>{var g,_;return{...t,results:{participants:((g=t==null?void 0:t.results)==null?void 0:g.participants)||[],messages:[e==null?void 0:e.optimistic,...(_=t==null?void 0:t.results)==null?void 0:_.messages]}}}),c=C.chunk(u,10);return{pageParams:[void 0,...c.slice(0,-1).map(t=>t.at(-1).createdAt)],pages:c.flat()}}),{previousMessages:o}},onError:(e,s,o)=>{a.setQueryData([T.TICKET_CONVERSATION,s==null?void 0:s.ticketId],o.previousMessages)},onSettled:(e,s,o,l)=>{a.invalidateQueries({queryKey:[T.TICKET_CONVERSATION,o==null?void 0:o.ticketId]})},...i});return{...n,mutate:async(e,s)=>{const{onSuccess:o,onError:l,...u}=s;try{await w.promise(n.mutateAsync(e,u),{pending:"Agregando Mensaje al Ticket...",success:{render({data:c}){return M(o)&&o(c),"Se envió el mensaje con éxito"}}}),a.invalidateQueries([T.ASSIGNED_LIST]),a.invalidateQueries([T.GENERATED_LIST])}catch(c){const m=V(c,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");M(l)&&l(m),w.error(m,{type:v(c)})}}}},J=A(S.lazy(()=>I(()=>import("./TicketMessages-CevStYD-.js"),__vite__mapDeps([0,1,2,3,4])))),X=A(S.lazy(()=>I(()=>import("./TicketAddAttachmentFiles-CMFVKxzl.js"),__vite__mapDeps([5,1,2,3,4])))),Z=A(S.lazy(()=>I(()=>import("./TicketMessageInput-BFbF6y2B.js"),__vite__mapDeps([6,1,7])))),k=({ticket:i,queryTicketConversation:a})=>{var x;const{mutate:n,isLoading:r}=H(),e=b(),[s,o]=S.useState(!1),l=$().shape({message:B().required("El mensaje es requerido"),attachments:G()}),u=U({validateOnChange:!1,enableReinitialize:!1,initialValues:{message:"",attachments:[]},validationSchema:l,onSubmit:(h,{setSubmitting:d,resetForm:f})=>{const O=Y(i==null?void 0:i.id,h,e);n(O,{onSuccess:()=>{d(!1),f()},onError:()=>{d(!1)}})}}),{handleSubmit:c,isSubmitting:m,values:t,setFieldValue:g,validateForm:_}=u,y=m||r,F=h=>{const d=Array.from(h.target.files);g("attachments",[...d,...t.attachments])},L=h=>{var d;g("attachments",(d=t==null?void 0:t.attachments)==null?void 0:d.filter(f=>f!==h))},N=async h=>{var f;h.preventDefault(),o(!0);const d=await _();d&&((f=Object.keys(d))==null?void 0:f.length)>0&&(window.scrollTo(0,0),w.warn("Verifique todos los campos obligatorios")),c()},P=S.useMemo(()=>t==null?void 0:t.attachments,[t==null?void 0:t.attachments]);return p.jsxs(p.Fragment,{children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(D,{sx:{overflow:"hidden"},children:p.jsx(J,{queryTicketConversation:a,scroll:s,setScroll:o})}),p.jsxs(D,{flex:1,justifyContent:"flex-end",children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(z,{}),!y&&p.jsx(X,{files:P,isLoading:y,handleRemoveFile:L}),((x=i==null?void 0:i.status)==null?void 0:x.id)!=="3"&&p.jsx(Z,{formik:u,isLoading:y,handleAddMessage:N,handleFileChange:F})]})]})};k.propTypes={queryTicketConversation:E.shape({isFetching:E.any}),ticket:E.shape({id:E.any,status:E.shape({id:E.string})})};export{k as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/js/TicketMessages-CevStYD-.js","assets/js/vendor-B39b6gT1.js","assets/js/index-Kl2QvVyT.js","assets/css/build-Bl0dWaDY.css","assets/js/getFileFormat-1mdVNW85.js","assets/js/TicketAddAttachmentFiles-CMFVKxzl.js","assets/js/TicketMessageInput-BFbF6y2B.js","assets/js/formik.esm-CRn2DIxC.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=TicketConversationLayout-DyITHJ6F.js.map
